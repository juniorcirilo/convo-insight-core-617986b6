{
  "openapi": "3.0.3",
  "info": {
    "title": "LiveChat WhatsApp API",
    "description": "API completa para gerenciamento de conversas WhatsApp, incluindo mensagens, tickets, agentes de IA, an√°lise de sentimento e muito mais.\n\n## Autentica√ß√£o\n\nA API suporta tr√™s tipos de autentica√ß√£o:\n\n1. **JWT Bearer Token**: Para endpoints autenticados de usu√°rios\n2. **Service Role Key**: Para opera√ß√µes administrativas e edge functions\n3. **Widget Token**: Para o widget de chat p√∫blico\n\n## Base URL\n\n- **Local**: `http://localhost:54321/functions/v1`\n- **Produ√ß√£o**: Configurar conforme ambiente\n\n## Rate Limiting\n\nAlguns endpoints possuem rate limiting. Verifique os headers de resposta para informa√ß√µes.",
    "version": "1.0.0",
    "contact": {
      "name": "Suporte LiveChat",
      "email": "suporte@livechat.com"
    },
    "license": {
      "name": "Propriet√°rio"
    }
  },
  "servers": [
    {
      "url": "http://localhost:54321/functions/v1",
      "description": "Ambiente Local (Supabase)"
    },
    {
      "url": "http://192.168.3.100:54321/functions/v1",
      "description": "Ambiente de Desenvolvimento"
    }
  ],
  "tags": [
    {
      "name": "WhatsApp",
      "description": "Opera√ß√µes de mensagens WhatsApp"
    },
    {
      "name": "AI",
      "description": "Funcionalidades de Intelig√™ncia Artificial"
    },
    {
      "name": "Webhook",
      "description": "Webhooks da Evolution API"
    },
    {
      "name": "Widget",
      "description": "API do Widget de Chat"
    },
    {
      "name": "Admin",
      "description": "Opera√ß√µes administrativas"
    },
    {
      "name": "Media",
      "description": "Gerenciamento de m√≠dia"
    },
    {
      "name": "Instances",
      "description": "Gerenciamento de inst√¢ncias WhatsApp"
    }
  ],
  "paths": {
    "/send-whatsapp-message": {
      "post": {
        "tags": ["WhatsApp"],
        "summary": "Enviar mensagem WhatsApp",
        "description": "Envia uma mensagem WhatsApp (texto, imagem, √°udio, v√≠deo ou documento) atrav√©s da Evolution API e armazena no banco de dados.",
        "operationId": "sendWhatsAppMessage",
        "security": [{"ServiceRoleKey": []}],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/SendMessageRequest"
              },
              "examples": {
                "text": {
                  "summary": "Mensagem de texto",
                  "value": {
                    "conversationId": "550e8400-e29b-41d4-a716-446655440000",
                    "content": "Ol√°! Como posso ajudar voc√™ hoje?",
                    "messageType": "text"
                  }
                },
                "image": {
                  "summary": "Mensagem com imagem",
                  "value": {
                    "conversationId": "550e8400-e29b-41d4-a716-446655440000",
                    "content": "Confira nossa promo√ß√£o!",
                    "messageType": "image",
                    "mediaUrl": "https://example.com/promo.jpg",
                    "mediaMimetype": "image/jpeg"
                  }
                },
                "document": {
                  "summary": "Envio de documento",
                  "value": {
                    "conversationId": "550e8400-e29b-41d4-a716-446655440000",
                    "content": "Segue o contrato em anexo",
                    "messageType": "document",
                    "mediaBase64": "JVBERi0xLjQKJeLjz9MKMyAwIG9...",
                    "mediaMimetype": "application/pdf",
                    "fileName": "contrato.pdf"
                  }
                },
                "reply": {
                  "summary": "Resposta a mensagem",
                  "value": {
                    "conversationId": "550e8400-e29b-41d4-a716-446655440000",
                    "content": "Sim, est√° correto!",
                    "messageType": "text",
                    "quotedMessageId": "3A123ABC456DEF789"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Mensagem enviada com sucesso",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SendMessageResponse"
                },
                "example": {
                  "success": true,
                  "message": {
                    "id": "550e8400-e29b-41d4-a716-446655440001",
                    "conversation_id": "550e8400-e29b-41d4-a716-446655440000",
                    "message_id": "3A789XYZ123ABC456",
                    "content": "Ol√°! Como posso ajudar voc√™ hoje?",
                    "message_type": "text",
                    "is_from_me": true,
                    "status": "sent",
                    "timestamp": "2026-01-22T14:30:00.000Z"
                  }
                }
              }
            }
          },
          "400": {
            "description": "Par√¢metros inv√°lidos",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "conversationId e messageType s√£o obrigat√≥rios"
                }
              }
            }
          },
          "404": {
            "description": "Conversa n√£o encontrada",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "500": {
            "description": "Erro interno do servidor",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/edit-whatsapp-message": {
      "post": {
        "tags": ["WhatsApp"],
        "summary": "Editar mensagem WhatsApp",
        "description": "Edita uma mensagem WhatsApp previamente enviada. A edi√ß√£o s√≥ √© permitida dentro de 15 minutos ap√≥s o envio.",
        "operationId": "editWhatsAppMessage",
        "security": [{"ServiceRoleKey": []}],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/EditMessageRequest"
              },
              "example": {
                "messageId": "3A789XYZ123ABC456",
                "conversationId": "550e8400-e29b-41d4-a716-446655440000",
                "newContent": "Ol√°! Como posso ajudar voc√™ hoje? üòä"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Mensagem editada com sucesso",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/EditMessageResponse"
                },
                "example": {
                  "success": true,
                  "message": {
                    "id": "550e8400-e29b-41d4-a716-446655440001",
                    "content": "Ol√°! Como posso ajudar voc√™ hoje? üòä",
                    "original_content": "Ol√°! Como posso ajudar voc√™ hoje?",
                    "edited_at": "2026-01-22T14:35:00.000Z"
                  }
                }
              }
            }
          },
          "400": {
            "description": "Tempo de edi√ß√£o expirado ou par√¢metros inv√°lidos",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Mensagem n√£o pode ser editada ap√≥s 15 minutos"
                }
              }
            }
          }
        }
      }
    },
    "/mark-messages-read": {
      "post": {
        "tags": ["WhatsApp"],
        "summary": "Marcar mensagens como lidas",
        "description": "Marca mensagens como lidas tanto localmente quanto via Evolution API (confirma√ß√£o de leitura bidirecional).",
        "operationId": "markMessagesRead",
        "security": [{"ServiceRoleKey": []}],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/MarkReadRequest"
              },
              "examples": {
                "all": {
                  "summary": "Marcar todas como lidas",
                  "value": {
                    "conversationId": "550e8400-e29b-41d4-a716-446655440000"
                  }
                },
                "specific": {
                  "summary": "Marcar mensagens espec√≠ficas",
                  "value": {
                    "conversationId": "550e8400-e29b-41d4-a716-446655440000",
                    "messageIds": ["3A789XYZ123ABC456", "3A789XYZ123ABC457"]
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Mensagens marcadas como lidas",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/MarkReadResponse"
                },
                "example": {
                  "success": true,
                  "markedCount": 5,
                  "messageIds": ["3A789XYZ123ABC456", "3A789XYZ123ABC457"]
                }
              }
            }
          }
        }
      }
    },
    "/evolution-webhook": {
      "post": {
        "tags": ["Webhook"],
        "summary": "Webhook da Evolution API",
        "description": "Endpoint que recebe eventos da Evolution API (WhatsApp). Processa cria√ß√£o de mensagens, atualiza√ß√µes de status, estado de conex√£o, rea√ß√µes e edi√ß√µes de mensagens.\n\n**Este endpoint √© chamado automaticamente pela Evolution API e n√£o deve ser chamado manualmente.**",
        "operationId": "evolutionWebhook",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/WebhookPayload"
              },
              "examples": {
                "messageUpsert": {
                  "summary": "Nova mensagem recebida",
                  "value": {
                    "event": "messages.upsert",
                    "instance": "minha-instancia",
                    "data": {
                      "key": {
                        "id": "3A789XYZ123ABC456",
                        "remoteJid": "5541999999999@s.whatsapp.net",
                        "fromMe": false
                      },
                      "pushName": "Jo√£o Silva",
                      "message": {
                        "conversation": "Ol√°, preciso de ajuda!"
                      },
                      "messageTimestamp": 1737555000
                    }
                  }
                },
                "messageUpdate": {
                  "summary": "Status de mensagem atualizado",
                  "value": {
                    "event": "messages.update",
                    "instance": "minha-instancia",
                    "data": {
                      "key": {
                        "id": "3A789XYZ123ABC456",
                        "remoteJid": "5541999999999@s.whatsapp.net"
                      },
                      "status": "READ"
                    }
                  }
                },
                "connectionUpdate": {
                  "summary": "Estado de conex√£o",
                  "value": {
                    "event": "connection.update",
                    "instance": "minha-instancia",
                    "data": {
                      "state": "open"
                    }
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Webhook processado com sucesso",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {"type": "boolean"},
                    "event": {"type": "string"}
                  }
                },
                "example": {
                  "success": true,
                  "event": "messages.upsert"
                }
              }
            }
          }
        }
      }
    },
    "/ai-agent-respond": {
      "post": {
        "tags": ["AI"],
        "summary": "Resposta autom√°tica do agente de IA",
        "description": "Gera respostas autom√°ticas usando IA (GROQ LLM) para conversas WhatsApp. Suporta escalonamento, hor√°rio comercial e integra√ß√£o com base de conhecimento.",
        "operationId": "aiAgentRespond",
        "security": [{"ServiceRoleKey": []}],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/AIAgentRequest"
              },
              "example": {
                "conversationId": "550e8400-e29b-41d4-a716-446655440000",
                "messageId": "550e8400-e29b-41d4-a716-446655440001"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Resposta gerada ou processamento pulado",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/AIAgentResponse"
                },
                "examples": {
                  "success": {
                    "summary": "Resposta gerada com sucesso",
                    "value": {
                      "success": true,
                      "response": "Ol√°! Obrigado por entrar em contato...",
                      "tokens": 150,
                      "responseTime": 1250
                    }
                  },
                  "skipped": {
                    "summary": "Processamento pulado",
                    "value": {
                      "success": true,
                      "skipped": true,
                      "reason": "human_mode"
                    }
                  },
                  "escalated": {
                    "summary": "Escalonado para humano",
                    "value": {
                      "success": true,
                      "escalated": true,
                      "response": "Um momento, vou transferir voc√™ para um atendente."
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/analyze-whatsapp-sentiment": {
      "post": {
        "tags": ["AI"],
        "summary": "Analisar sentimento da conversa",
        "description": "Analisa o sentimento das mensagens do cliente em uma conversa usando IA. Retorna classifica√ß√£o positivo/neutro/negativo com pontua√ß√£o de confian√ßa.",
        "operationId": "analyzeSentiment",
        "security": [{"BearerAuth": []}],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/SentimentRequest"
              },
              "example": {
                "conversationId": "550e8400-e29b-41d4-a716-446655440000"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "An√°lise de sentimento conclu√≠da",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SentimentResponse"
                },
                "examples": {
                  "positive": {
                    "summary": "Sentimento positivo",
                    "value": {
                      "success": true,
                      "analysis": {
                        "id": "550e8400-e29b-41d4-a716-446655440002",
                        "conversation_id": "550e8400-e29b-41d4-a716-446655440000",
                        "sentiment": "positive",
                        "confidence_score": 0.87,
                        "summary": "Cliente satisfeito com o atendimento e produto recebido",
                        "reasoning": "O cliente usou express√µes de gratid√£o e satisfa√ß√£o ao longo da conversa",
                        "messages_analyzed": 12
                      }
                    }
                  },
                  "negative": {
                    "summary": "Sentimento negativo",
                    "value": {
                      "success": true,
                      "analysis": {
                        "id": "550e8400-e29b-41d4-a716-446655440002",
                        "conversation_id": "550e8400-e29b-41d4-a716-446655440000",
                        "sentiment": "negative",
                        "confidence_score": 0.92,
                        "summary": "Cliente frustrado com atraso na entrega",
                        "reasoning": "M√∫ltiplas mensagens expressando frustra√ß√£o e urg√™ncia",
                        "messages_analyzed": 8
                      }
                    }
                  },
                  "insufficient": {
                    "summary": "Mensagens insuficientes",
                    "value": {
                      "success": true,
                      "message": "Mensagens insuficientes para an√°lise",
                      "messagesFound": 2
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/categorize-whatsapp-conversation": {
      "post": {
        "tags": ["AI"],
        "summary": "Categorizar conversa",
        "description": "Categoriza uma conversa WhatsApp em t√≥picos predefinidos (vendas, suporte, etc.) usando an√°lise de IA.",
        "operationId": "categorizeConversation",
        "security": [{"BearerAuth": []}],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/CategorizeRequest"
              },
              "example": {
                "conversationId": "550e8400-e29b-41d4-a716-446655440000"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Categoriza√ß√£o conclu√≠da",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CategorizeResponse"
                },
                "example": {
                  "success": true,
                  "metadata": {
                    "topics": ["suporte_tecnico", "reclamacao"],
                    "primary_topic": "suporte_tecnico",
                    "ai_confidence": 0.89,
                    "categorized_at": "2026-01-22T14:30:00.000Z",
                    "categorization_model": "llama-3.1-8b-instant",
                    "ai_reasoning": "Cliente relatou problema t√©cnico com o produto"
                  },
                  "message": "Conversa categorizada com sucesso"
                }
              }
            }
          }
        }
      }
    },
    "/compose-whatsapp-message": {
      "post": {
        "tags": ["AI"],
        "summary": "Compor mensagem com IA",
        "description": "Composi√ß√£o de mensagens assistida por IA com a√ß√µes como expandir, reformular, traduzir, corrigir gram√°tica e ajustar tom.",
        "operationId": "composeMessage",
        "security": [{"BearerAuth": []}],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/ComposeRequest"
              },
              "examples": {
                "expand": {
                  "summary": "Expandir mensagem",
                  "value": {
                    "message": "Obrigado",
                    "action": "expand"
                  }
                },
                "formal": {
                  "summary": "Tom formal",
                  "value": {
                    "message": "Oi, d√° pra ver meu pedido?",
                    "action": "formal"
                  }
                },
                "translate": {
                  "summary": "Traduzir para ingl√™s",
                  "value": {
                    "message": "Obrigado pelo seu contato!",
                    "action": "translate",
                    "targetLanguage": "en"
                  }
                },
                "fix_grammar": {
                  "summary": "Corrigir gram√°tica",
                  "value": {
                    "message": "Agente vc pode me ajudar com isso aki?",
                    "action": "fix_grammar"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Mensagem composta com sucesso",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ComposeResponse"
                },
                "examples": {
                  "expand": {
                    "summary": "Mensagem expandida",
                    "value": {
                      "original": "Obrigado",
                      "composed": "Muito obrigado pelo seu contato! Ficamos felizes em poder ajud√°-lo. Caso tenha mais alguma d√∫vida, estamos √† disposi√ß√£o.",
                      "action": "expand"
                    }
                  },
                  "formal": {
                    "summary": "Tom formal aplicado",
                    "value": {
                      "original": "Oi, d√° pra ver meu pedido?",
                      "composed": "Prezado cliente, poderia por gentileza verificar o status do meu pedido?",
                      "action": "formal"
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/suggest-smart-replies": {
      "post": {
        "tags": ["AI"],
        "summary": "Sugerir respostas inteligentes",
        "description": "Gera sugest√µes de respostas inteligentes baseadas no contexto da conversa.",
        "operationId": "suggestSmartReplies",
        "security": [{"ServiceRoleKey": []}],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/SmartRepliesRequest"
              },
              "example": {
                "conversationId": "550e8400-e29b-41d4-a716-446655440000"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Sugest√µes geradas com sucesso",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SmartRepliesResponse"
                },
                "example": {
                  "suggestions": [
                    {
                      "text": "Claro! Vou verificar isso para voc√™ agora mesmo.",
                      "tone": "friendly"
                    },
                    {
                      "text": "Prezado cliente, verificarei a situa√ß√£o imediatamente.",
                      "tone": "formal"
                    },
                    {
                      "text": "Um momento, vou checar.",
                      "tone": "direct"
                    }
                  ],
                  "context": {
                    "contactName": "Jo√£o Silva",
                    "lastMessage": "Voc√™s podem verificar meu pedido?"
                  }
                }
              }
            }
          }
        }
      }
    },
    "/generate-conversation-summary": {
      "post": {
        "tags": ["AI"],
        "summary": "Gerar resumo da conversa",
        "description": "Gera um resumo completo da conversa usando IA, incluindo pontos-chave, itens de a√ß√£o e avalia√ß√£o de sentimento.",
        "operationId": "generateSummary",
        "security": [{"ServiceRoleKey": []}],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/SummaryRequest"
              },
              "example": {
                "conversationId": "550e8400-e29b-41d4-a716-446655440000"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Resumo gerado com sucesso",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SummaryResponse"
                },
                "example": {
                  "success": true,
                  "summary": {
                    "id": "550e8400-e29b-41d4-a716-446655440003",
                    "conversation_id": "550e8400-e29b-41d4-a716-446655440000",
                    "summary": "Cliente entrou em contato para verificar status de pedido #12345. Pedido estava em tr√¢nsito e previs√£o de entrega foi confirmada para amanh√£. Cliente ficou satisfeito com a informa√ß√£o.",
                    "key_points": [
                      "Consulta sobre pedido #12345",
                      "Pedido em tr√¢nsito",
                      "Entrega prevista para amanh√£",
                      "Cliente satisfeito"
                    ],
                    "action_items": [
                      "Monitorar entrega do pedido",
                      "Enviar confirma√ß√£o quando entregue"
                    ],
                    "sentiment_at_time": "positive",
                    "messages_count": 15,
                    "period_start": "2026-01-22T10:00:00.000Z",
                    "period_end": "2026-01-22T14:30:00.000Z"
                  }
                }
              }
            }
          }
        }
      }
    },
    "/transcribe-audio": {
      "post": {
        "tags": ["AI", "Media"],
        "summary": "Transcrever √°udio",
        "description": "Transcreve mensagens de √°udio usando o modelo Whisper da GROQ e armazena a transcri√ß√£o no banco de dados.",
        "operationId": "transcribeAudio",
        "security": [{"ServiceRoleKey": []}],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/TranscribeRequest"
              },
              "example": {
                "messageId": "550e8400-e29b-41d4-a716-446655440001"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "√Åudio transcrito com sucesso",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/TranscribeResponse"
                },
                "example": {
                  "success": true,
                  "transcription": "Ol√°, estou ligando para verificar o status do meu pedido que fiz na semana passada."
                }
              }
            }
          }
        }
      }
    },
    "/get-media-signed-url": {
      "post": {
        "tags": ["Media"],
        "summary": "Obter URL assinada para m√≠dia",
        "description": "Gera URLs assinadas para acesso a arquivos de m√≠dia do WhatsApp armazenados no Supabase Storage com verifica√ß√£o de acesso.",
        "operationId": "getMediaSignedUrl",
        "security": [{"BearerAuth": []}],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/SignedUrlRequest"
              },
              "example": {
                "filePath": "minha-instancia/1737555000-3A789XYZ123ABC456.jpg",
                "conversationId": "550e8400-e29b-41d4-a716-446655440000"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "URL assinada gerada",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SignedUrlResponse"
                },
                "example": {
                  "signedUrl": "http://localhost:54321/storage/v1/object/sign/whatsapp-media/minha-instancia/1737555000-3A789XYZ123ABC456.jpg?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                }
              }
            }
          },
          "403": {
            "description": "Sem permiss√£o para acessar o arquivo",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/check-instances-status": {
      "post": {
        "tags": ["Instances"],
        "summary": "Verificar status das inst√¢ncias",
        "description": "Verifica o status de conex√£o de todas as inst√¢ncias WhatsApp via Evolution API.",
        "operationId": "checkInstancesStatus",
        "security": [{"ServiceRoleKey": []}],
        "responses": {
          "200": {
            "description": "Status verificado",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {"type": "boolean"},
                    "checked": {"type": "integer"},
                    "updated": {"type": "integer"}
                  }
                },
                "example": {
                  "success": true,
                  "checked": 5,
                  "updated": 2
                }
              }
            }
          }
        }
      }
    },
    "/test-instance-connection": {
      "post": {
        "tags": ["Instances"],
        "summary": "Testar conex√£o de inst√¢ncia",
        "description": "Testa a conex√£o de uma inst√¢ncia WhatsApp espec√≠fica.",
        "operationId": "testInstanceConnection",
        "security": [{"ServiceRoleKey": []}],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["instanceId"],
                "properties": {
                  "instanceId": {
                    "type": "string",
                    "format": "uuid",
                    "description": "ID da inst√¢ncia"
                  }
                }
              },
              "example": {
                "instanceId": "550e8400-e29b-41d4-a716-446655440000"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Resultado do teste",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {"type": "boolean"},
                    "connected": {"type": "boolean"},
                    "status": {"type": "string"},
                    "phoneNumber": {"type": "string"}
                  }
                },
                "example": {
                  "success": true,
                  "connected": true,
                  "status": "open",
                  "phoneNumber": "5541999999999"
                }
              }
            }
          }
        }
      }
    },
    "/widget-api/config": {
      "get": {
        "tags": ["Widget"],
        "summary": "Obter configura√ß√£o do widget",
        "description": "Retorna a configura√ß√£o do widget de chat e status online.",
        "operationId": "getWidgetConfig",
        "parameters": [
          {
            "name": "id",
            "in": "query",
            "required": true,
            "schema": {
              "type": "string",
              "format": "uuid"
            },
            "description": "ID do widget"
          }
        ],
        "responses": {
          "200": {
            "description": "Configura√ß√£o do widget",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/WidgetConfig"
                },
                "example": {
                  "id": "550e8400-e29b-41d4-a716-446655440000",
                  "name": "Suporte Online",
                  "enabled": true,
                  "primary_color": "#10B981",
                  "position": "bottom-right",
                  "welcome_title": "Ol√°! üëã",
                  "welcome_message": "Como podemos ajudar voc√™ hoje?",
                  "require_name": true,
                  "require_email": false,
                  "require_phone": true,
                  "is_online": true
                }
              }
            }
          }
        }
      }
    },
    "/widget-api/conversation": {
      "post": {
        "tags": ["Widget"],
        "summary": "Criar conversa do widget",
        "description": "Cria uma nova conversa iniciada pelo widget de chat.",
        "operationId": "createWidgetConversation",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/WidgetConversationRequest"
              },
              "example": {
                "widget_id": "550e8400-e29b-41d4-a716-446655440000",
                "visitor_name": "Maria Santos",
                "visitor_phone": "5541988888888",
                "user_agent": "Mozilla/5.0...",
                "page_url": "https://exemplo.com/produtos"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Conversa criada",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/WidgetConversationResponse"
                },
                "example": {
                  "conversation_id": "550e8400-e29b-41d4-a716-446655440001",
                  "token": "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6"
                }
              }
            }
          }
        }
      }
    },
    "/widget-api/message": {
      "post": {
        "tags": ["Widget"],
        "summary": "Enviar mensagem do widget",
        "description": "Envia uma mensagem do visitante atrav√©s do widget.",
        "operationId": "sendWidgetMessage",
        "security": [{"WidgetToken": []}],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/WidgetMessageRequest"
              },
              "example": {
                "content": "Ol√°, preciso de ajuda com meu pedido"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Mensagem enviada",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "message_id": {"type": "string", "format": "uuid"}
                  }
                },
                "example": {
                  "message_id": "550e8400-e29b-41d4-a716-446655440002"
                }
              }
            }
          }
        }
      }
    },
    "/widget-api/messages": {
      "get": {
        "tags": ["Widget"],
        "summary": "Obter mensagens do widget",
        "description": "Obt√©m as mensagens de uma conversa do widget.",
        "operationId": "getWidgetMessages",
        "security": [{"WidgetToken": []}],
        "responses": {
          "200": {
            "description": "Lista de mensagens",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/WidgetMessagesResponse"
                },
                "example": {
                  "messages": [
                    {
                      "id": "550e8400-e29b-41d4-a716-446655440002",
                      "content": "Ol√°, preciso de ajuda com meu pedido",
                      "is_from_visitor": true,
                      "created_at": "2026-01-22T14:30:00.000Z",
                      "source": "widget"
                    },
                    {
                      "id": "550e8400-e29b-41d4-a716-446655440003",
                      "content": "Claro! Qual √© o n√∫mero do seu pedido?",
                      "is_from_visitor": false,
                      "created_at": "2026-01-22T14:31:00.000Z",
                      "source": "whatsapp"
                    }
                  ]
                }
              }
            }
          }
        }
      }
    },
    "/admin-reset-password": {
      "post": {
        "tags": ["Admin"],
        "summary": "Resetar senha de usu√°rio",
        "description": "Permite que administradores resetem senhas de outros usu√°rios.",
        "operationId": "adminResetPassword",
        "security": [{"BearerAuth": []}],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/ResetPasswordRequest"
              },
              "example": {
                "userId": "550e8400-e29b-41d4-a716-446655440000",
                "newPassword": "novaSenhaSegura123!"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Senha resetada com sucesso",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                },
                "example": {
                  "success": true,
                  "message": "Senha alterada com sucesso"
                }
              }
            }
          },
          "403": {
            "description": "Sem permiss√£o de administrador",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/invite-team-member": {
      "post": {
        "tags": ["Admin"],
        "summary": "Convidar membro da equipe",
        "description": "Permite que administradores convidem novos membros criando contas e atribuindo pap√©is.",
        "operationId": "inviteTeamMember",
        "security": [{"BearerAuth": []}],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/InviteRequest"
              },
              "example": {
                "email": "novo.agente@empresa.com",
                "fullName": "Carlos Silva",
                "role": "agent"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Convite enviado com sucesso",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/InviteResponse"
                },
                "example": {
                  "success": true,
                  "userId": "550e8400-e29b-41d4-a716-446655440005",
                  "message": "Convite enviado para novo.agente@empresa.com. O usu√°rio receber√° um email para confirmar a conta."
                }
              }
            }
          }
        }
      }
    }
  },
  "components": {
    "securitySchemes": {
      "BearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT",
        "description": "Token JWT do usu√°rio autenticado"
      },
      "ServiceRoleKey": {
        "type": "apiKey",
        "in": "header",
        "name": "Authorization",
        "description": "Service Role Key do Supabase (Bearer {service_role_key})"
      },
      "WidgetToken": {
        "type": "apiKey",
        "in": "header",
        "name": "x-widget-token",
        "description": "Token do visitante do widget"
      }
    },
    "schemas": {
      "SendMessageRequest": {
        "type": "object",
        "required": ["conversationId", "messageType"],
        "properties": {
          "conversationId": {
            "type": "string",
            "format": "uuid",
            "description": "ID da conversa"
          },
          "content": {
            "type": "string",
            "description": "Conte√∫do da mensagem (obrigat√≥rio para texto)"
          },
          "messageType": {
            "type": "string",
            "enum": ["text", "image", "audio", "video", "document"],
            "description": "Tipo da mensagem"
          },
          "mediaUrl": {
            "type": "string",
            "format": "uri",
            "description": "URL do arquivo de m√≠dia"
          },
          "mediaBase64": {
            "type": "string",
            "description": "M√≠dia codificada em Base64"
          },
          "mediaMimetype": {
            "type": "string",
            "description": "Tipo MIME da m√≠dia"
          },
          "fileName": {
            "type": "string",
            "description": "Nome do arquivo (para documentos)"
          },
          "quotedMessageId": {
            "type": "string",
            "description": "ID da mensagem sendo respondida"
          },
          "isSupervisorMessage": {
            "type": "boolean",
            "description": "Marcar como mensagem de supervisor"
          },
          "supervisorId": {
            "type": "string",
            "format": "uuid",
            "description": "ID do supervisor"
          }
        }
      },
      "SendMessageResponse": {
        "type": "object",
        "properties": {
          "success": {"type": "boolean"},
          "message": {
            "type": "object",
            "properties": {
              "id": {"type": "string", "format": "uuid"},
              "conversation_id": {"type": "string", "format": "uuid"},
              "message_id": {"type": "string"},
              "content": {"type": "string"},
              "message_type": {"type": "string"},
              "is_from_me": {"type": "boolean"},
              "status": {"type": "string"},
              "timestamp": {"type": "string", "format": "date-time"}
            }
          },
          "error": {"type": "string"}
        }
      },
      "EditMessageRequest": {
        "type": "object",
        "required": ["messageId", "conversationId", "newContent"],
        "properties": {
          "messageId": {
            "type": "string",
            "description": "ID da mensagem WhatsApp"
          },
          "conversationId": {
            "type": "string",
            "format": "uuid",
            "description": "ID da conversa"
          },
          "newContent": {
            "type": "string",
            "description": "Novo conte√∫do da mensagem"
          }
        }
      },
      "EditMessageResponse": {
        "type": "object",
        "properties": {
          "success": {"type": "boolean"},
          "message": {
            "type": "object",
            "properties": {
              "id": {"type": "string", "format": "uuid"},
              "content": {"type": "string"},
              "original_content": {"type": "string"},
              "edited_at": {"type": "string", "format": "date-time"}
            }
          },
          "error": {"type": "string"}
        }
      },
      "MarkReadRequest": {
        "type": "object",
        "required": ["conversationId"],
        "properties": {
          "conversationId": {
            "type": "string",
            "format": "uuid",
            "description": "ID da conversa"
          },
          "messageIds": {
            "type": "array",
            "items": {"type": "string"},
            "description": "IDs espec√≠ficos para marcar"
          }
        }
      },
      "MarkReadResponse": {
        "type": "object",
        "properties": {
          "success": {"type": "boolean"},
          "markedCount": {"type": "integer"},
          "messageIds": {
            "type": "array",
            "items": {"type": "string"}
          },
          "error": {"type": "string"}
        }
      },
      "WebhookPayload": {
        "type": "object",
        "required": ["event", "instance", "data"],
        "properties": {
          "event": {
            "type": "string",
            "enum": ["messages.upsert", "messages.update", "messages.delete", "connection.update", "send.message"],
            "description": "Tipo de evento"
          },
          "instance": {
            "type": "string",
            "description": "Nome ou ID da inst√¢ncia"
          },
          "data": {
            "type": "object",
            "description": "Dados do evento"
          }
        }
      },
      "AIAgentRequest": {
        "type": "object",
        "required": ["conversationId", "messageId"],
        "properties": {
          "conversationId": {
            "type": "string",
            "format": "uuid"
          },
          "messageId": {
            "type": "string",
            "format": "uuid"
          }
        }
      },
      "AIAgentResponse": {
        "type": "object",
        "properties": {
          "success": {"type": "boolean"},
          "response": {"type": "string"},
          "tokens": {"type": "integer"},
          "responseTime": {"type": "integer"},
          "skipped": {"type": "boolean"},
          "reason": {
            "type": "string",
            "enum": ["human_mode", "no_config", "outside_hours", "no_client_message"]
          },
          "escalated": {"type": "boolean"},
          "error": {"type": "string"}
        }
      },
      "SentimentRequest": {
        "type": "object",
        "required": ["conversationId"],
        "properties": {
          "conversationId": {
            "type": "string",
            "format": "uuid"
          }
        }
      },
      "SentimentResponse": {
        "type": "object",
        "properties": {
          "success": {"type": "boolean"},
          "analysis": {
            "type": "object",
            "properties": {
              "id": {"type": "string", "format": "uuid"},
              "conversation_id": {"type": "string", "format": "uuid"},
              "sentiment": {
                "type": "string",
                "enum": ["positive", "neutral", "negative"]
              },
              "confidence_score": {
                "type": "number",
                "minimum": 0,
                "maximum": 1
              },
              "summary": {"type": "string"},
              "reasoning": {"type": "string"},
              "messages_analyzed": {"type": "integer"}
            }
          },
          "message": {"type": "string"},
          "messagesFound": {"type": "integer"}
        }
      },
      "CategorizeRequest": {
        "type": "object",
        "required": ["conversationId"],
        "properties": {
          "conversationId": {
            "type": "string",
            "format": "uuid"
          }
        }
      },
      "CategorizeResponse": {
        "type": "object",
        "properties": {
          "success": {"type": "boolean"},
          "metadata": {
            "type": "object",
            "properties": {
              "topics": {
                "type": "array",
                "items": {"type": "string"}
              },
              "primary_topic": {"type": "string"},
              "ai_confidence": {"type": "number"},
              "categorized_at": {"type": "string", "format": "date-time"},
              "categorization_model": {"type": "string"},
              "ai_reasoning": {"type": "string"}
            }
          },
          "message": {"type": "string"},
          "error": {"type": "string"}
        }
      },
      "ComposeRequest": {
        "type": "object",
        "required": ["message", "action"],
        "properties": {
          "message": {
            "type": "string",
            "description": "Mensagem original"
          },
          "action": {
            "type": "string",
            "enum": ["expand", "rephrase", "my_tone", "friendly", "formal", "fix_grammar", "translate"],
            "description": "A√ß√£o a realizar"
          },
          "targetLanguage": {
            "type": "string",
            "enum": ["en", "es", "fr", "de", "it", "pt"],
            "description": "Idioma alvo (para tradu√ß√£o)"
          }
        }
      },
      "ComposeResponse": {
        "type": "object",
        "properties": {
          "original": {"type": "string"},
          "composed": {"type": "string"},
          "action": {"type": "string"},
          "error": {"type": "string"}
        }
      },
      "SmartRepliesRequest": {
        "type": "object",
        "required": ["conversationId"],
        "properties": {
          "conversationId": {
            "type": "string",
            "format": "uuid"
          }
        }
      },
      "SmartRepliesResponse": {
        "type": "object",
        "properties": {
          "suggestions": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "text": {"type": "string"},
                "tone": {
                  "type": "string",
                  "enum": ["formal", "friendly", "direct"]
                }
              }
            }
          },
          "context": {
            "type": "object",
            "properties": {
              "contactName": {"type": "string"},
              "lastMessage": {"type": "string"}
            }
          },
          "error": {"type": "string"}
        }
      },
      "SummaryRequest": {
        "type": "object",
        "required": ["conversationId"],
        "properties": {
          "conversationId": {
            "type": "string",
            "format": "uuid"
          }
        }
      },
      "SummaryResponse": {
        "type": "object",
        "properties": {
          "success": {"type": "boolean"},
          "summary": {
            "type": "object",
            "properties": {
              "id": {"type": "string", "format": "uuid"},
              "conversation_id": {"type": "string", "format": "uuid"},
              "summary": {"type": "string"},
              "key_points": {
                "type": "array",
                "items": {"type": "string"}
              },
              "action_items": {
                "type": "array",
                "items": {"type": "string"}
              },
              "sentiment_at_time": {"type": "string"},
              "messages_count": {"type": "integer"},
              "period_start": {"type": "string", "format": "date-time"},
              "period_end": {"type": "string", "format": "date-time"}
            }
          },
          "message": {"type": "string"},
          "error": {"type": "string"}
        }
      },
      "TranscribeRequest": {
        "type": "object",
        "required": ["messageId"],
        "properties": {
          "messageId": {
            "type": "string",
            "format": "uuid",
            "description": "ID da mensagem de √°udio"
          }
        }
      },
      "TranscribeResponse": {
        "type": "object",
        "properties": {
          "success": {"type": "boolean"},
          "transcription": {"type": "string"},
          "error": {"type": "string"}
        }
      },
      "SignedUrlRequest": {
        "type": "object",
        "required": ["filePath"],
        "properties": {
          "filePath": {
            "type": "string",
            "description": "Caminho do arquivo no bucket"
          },
          "conversationId": {
            "type": "string",
            "format": "uuid",
            "description": "Para verifica√ß√£o de acesso"
          }
        }
      },
      "SignedUrlResponse": {
        "type": "object",
        "properties": {
          "signedUrl": {"type": "string", "format": "uri"},
          "error": {"type": "string"}
        }
      },
      "WidgetConfig": {
        "type": "object",
        "properties": {
          "id": {"type": "string", "format": "uuid"},
          "name": {"type": "string"},
          "enabled": {"type": "boolean"},
          "primary_color": {"type": "string"},
          "position": {
            "type": "string",
            "enum": ["bottom-right", "bottom-left"]
          },
          "welcome_title": {"type": "string"},
          "welcome_message": {"type": "string"},
          "require_name": {"type": "boolean"},
          "require_email": {"type": "boolean"},
          "require_phone": {"type": "boolean"},
          "is_online": {"type": "boolean"}
        }
      },
      "WidgetConversationRequest": {
        "type": "object",
        "required": ["widget_id"],
        "properties": {
          "widget_id": {"type": "string", "format": "uuid"},
          "visitor_name": {"type": "string"},
          "visitor_email": {"type": "string", "format": "email"},
          "visitor_phone": {"type": "string"},
          "user_agent": {"type": "string"},
          "referrer_url": {"type": "string", "format": "uri"},
          "page_url": {"type": "string", "format": "uri"}
        }
      },
      "WidgetConversationResponse": {
        "type": "object",
        "properties": {
          "conversation_id": {"type": "string", "format": "uuid"},
          "token": {"type": "string"}
        }
      },
      "WidgetMessageRequest": {
        "type": "object",
        "required": ["content"],
        "properties": {
          "content": {"type": "string"}
        }
      },
      "WidgetMessagesResponse": {
        "type": "object",
        "properties": {
          "messages": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "id": {"type": "string", "format": "uuid"},
                "content": {"type": "string"},
                "is_from_visitor": {"type": "boolean"},
                "created_at": {"type": "string", "format": "date-time"},
                "source": {
                  "type": "string",
                  "enum": ["widget", "whatsapp"]
                }
              }
            }
          }
        }
      },
      "ResetPasswordRequest": {
        "type": "object",
        "required": ["userId", "newPassword"],
        "properties": {
          "userId": {
            "type": "string",
            "format": "uuid",
            "description": "ID do usu√°rio"
          },
          "newPassword": {
            "type": "string",
            "minLength": 6,
            "description": "Nova senha (m√≠nimo 6 caracteres)"
          }
        }
      },
      "InviteRequest": {
        "type": "object",
        "required": ["email", "fullName", "role"],
        "properties": {
          "email": {
            "type": "string",
            "format": "email"
          },
          "fullName": {
            "type": "string"
          },
          "role": {
            "type": "string",
            "enum": ["admin", "supervisor", "agent"]
          }
        }
      },
      "InviteResponse": {
        "type": "object",
        "properties": {
          "success": {"type": "boolean"},
          "userId": {"type": "string", "format": "uuid"},
          "message": {"type": "string"},
          "error": {"type": "string"}
        }
      },
      "SuccessResponse": {
        "type": "object",
        "properties": {
          "success": {"type": "boolean"},
          "message": {"type": "string"}
        }
      },
      "ErrorResponse": {
        "type": "object",
        "properties": {
          "error": {"type": "string"},
          "message": {"type": "string"},
          "statusCode": {"type": "integer"}
        }
      }
    }
  }
}
